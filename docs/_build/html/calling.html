

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Step 5: Calling the function &mdash; Automatic Carbon Offsetting  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Examples" href="examples.html" />
    <link rel="prev" title="Step 4: Adding additional code" href="additional.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Automatic Carbon Offsetting
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Requirements.html">Step 1: Creating SMTP account</a></li>
<li class="toctree-l1"><a class="reference internal" href="integrate.html">Step 2: Importing Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="Mail.html">Step 3: Embedding the function</a></li>
<li class="toctree-l1"><a class="reference internal" href="additional.html">Step 4: Adding additional code</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Step 5: Calling the function</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#adding-timeouts">Adding Timeouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#before-next-page">Before Next Page</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Automatic Carbon Offsetting</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Step 5: Calling the function</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/calling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="admonition note" id="calling">
<p class="admonition-title">Note</p>
<p><strong>Source Code:</strong> All source code described on this website can simply be copied into your <em>oTree</em> project
from the code block at the bottom of this section.</p>
</div>
<div class="section" id="step-5-calling-the-function">
<h1>Step 5: Calling the function<a class="headerlink" href="#step-5-calling-the-function" title="Permalink to this headline">¶</a></h1>
<p>This is the last step of integrating the software-module in your <em>oTree</em> project.
You need to add the following things in your pages.py file.</p>
<div class="section" id="adding-timeouts">
<h2>Adding Timeouts<a class="headerlink" href="#adding-timeouts" title="Permalink to this headline">¶</a></h2>
<p>The email should be sent once all players have finished the experiment. Since it’s impossible
to guarantee that every single player finishes the experiment you have to account for players that
have dropped out and might not finish the experiment on their own. One way to do this is to manually
force a timeout by clicking the “Advance slowest participants” button in <em>oTree’s</em> admin interface.
Like this:</p>
<img alt="_images/admin.jpg" class="align-center" src="_images/admin.jpg" />
<p>However, this can also be done more elegantly by adding a Timeout to every single page of your
experiment. By adding a timeout to every Page class in your pages.py file you don’t have to manually
advance the players and you can still make sure that every player finishes the experiment.
Add the following code to all your page classes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Page1</span><span class="p">(</span><span class="n">Page</span><span class="p">):</span>
    <span class="c1">#-------------------------</span>
    <span class="c1">#ALL YOUR OTHER CODE HERE</span>
    <span class="c1">#-------------------------</span>

    <span class="n">timeout_seconds</span> <span class="o">=</span> <span class="n">XX</span>  <span class="c1"># add amount of seconds until timeout happens</span>
</pre></div>
</div>
</div>
<div class="section" id="before-next-page">
<h2>Before Next Page<a class="headerlink" href="#before-next-page" title="Permalink to this headline">¶</a></h2>
<p>Lastly, the following lines have to be added to the last page of your experiment. All code within
the <code class="docutils literal notranslate"><span class="pre">before_next_page()</span></code> function is executed once the player finishes the last page of your
experiment. Click <a class="reference external" href="https://otree.readthedocs.io/en/latest/pages.html">here</a> for additional
information. The code below does the following:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Once a player finishes the experiment the <code class="docutils literal notranslate"><span class="pre">is_finished</span></code> field of the player is set to <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">set_all_players_finished()</span></code> function checks if every player has finished the experiment.</p></li>
<li><p>Once the last player finishes and therefore all players have finished the experiment,
the <code class="docutils literal notranslate"><span class="pre">send_payment_mail()</span></code> function is called and the email is sent.</p></li>
</ol>
</div></blockquote>
<p>This is an example of possible parameters for the function:</p>
<dl class="simple">
<dt><strong>Mail parameters:</strong></dt><dd><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">sum_saved_emission</span></code> field is the total weight of CO2 emission that was saved by participants.
Add your own variable here.</p></li>
<li><p>The unit of the weight is lbs.</p></li>
<li><p>The name of the experiment is Carbon Emission Task.</p></li>
<li><p>The name of the recipient is John Doe.</p></li>
<li><p>the recipient’s email address is <a class="reference external" href="mailto:john&#46;doe&#37;&#52;&#48;cet&#46;com">john<span>&#46;</span>doe<span>&#64;</span>cet<span>&#46;</span>com</a>. (Multiple addresses have to be specified in a list
e.g. [“<a class="reference external" href="mailto:john&#46;doe&#37;&#52;&#48;cet&#46;com">john<span>&#46;</span>doe<span>&#64;</span>cet<span>&#46;</span>com</a>”, “<a class="reference external" href="mailto:jane&#46;doe&#37;&#52;&#48;cet&#46;com">jane<span>&#46;</span>doe<span>&#64;</span>cet<span>&#46;</span>com</a>”].</p></li>
</ul>
</dd>
</dl>
<p>By adding the following code to the last page of your experiment, you successfully integrated the tool
for automatic carbon offsetting in your <em>oTree</em> project.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LAST_PAGE</span><span class="p">(</span><span class="n">Page</span><span class="p">):</span>
    <span class="c1">#-------------------------</span>
    <span class="c1">#ALL YOUR OTHER CODE HERE</span>
    <span class="c1">#-------------------------</span>

    <span class="k">def</span> <span class="nf">before_next_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#Is Finished fields and functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="n">is_finished</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsession</span><span class="o">.</span><span class="n">set_all_players_finished</span><span class="p">()</span>

        <span class="c1"># All finished check and send mail</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsession</span><span class="o">.</span><span class="n">all_players_finished</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subsession</span><span class="o">.</span><span class="n">send_payment_mail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subsession</span><span class="o">.</span><span class="n">sum_saved_emission</span><span class="p">,</span>
                                              <span class="s2">&quot;lbs&quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;Carbon Emission Task&quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;john.doe@cet.com&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="examples.html" class="btn btn-neutral float-right" title="Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="additional.html" class="btn btn-neutral float-left" title="Step 4: Adding additional code" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Noel Strahm.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>